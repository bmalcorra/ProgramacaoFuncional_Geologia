<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Intensivão de programação funcional em R aplicado à Geologia</title>
    <meta charset="utf-8" />
    <meta name="author" content="Bárbara Malcorra" />
    <meta name="date" content="2021-07-07" />
    <script src="libs/header-attrs-2.9/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Intensivão de programação funcional em R aplicado à Geologia
## ⚒<br/>Aula 2 - programação funcional
### Bárbara Malcorra
### PUCRS
### 2021-07-07

---








# Tidyverse


```r
library(tidyverse)
```

.pull-left[
&lt;img src="https://tidyverse.tidyverse.org/articles/tidyverse-logo.png" width="70%" style="display: block; margin: auto;" /&gt;

]

.pull-right[
&lt;img src="https://education.rstudio.com/blog/2020/07/teaching-the-tidyverse-in-2020-part-1-getting-started/img/tidyverse-packages.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---
# Pipe %&gt;%

- Atalho Ctrl + Shift + M

- Analisa o código do lado esquerdo e passa o resultado como o primeiro argumento do código do lado direito

&lt;img src="https://magrittr.tidyverse.org/logo.png" width="30%" style="display: block; margin: auto;" /&gt;

---
# Comandos lógicos

**&lt;** menor que  
**&gt;** maior que  
**&lt;=** menor igual a  
**&gt;=** maior igual a  
**==** igual a  
**%in%** faz parte de um grupo  
**is.na()** é NA  
**&amp;** e  
**|** ou  
**!** diferente de  

---
# Dados

- "Tidy Tuesday live screencast: Analyzing volcano eruptions in R" by David Robinson

&lt;https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md&gt;


```r
volcano &lt;- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/volcano.csv')
eruptions &lt;- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/eruptions.csv')
events &lt;- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/events.csv')
tree_rings &lt;- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/tree_rings.csv')
sulfur &lt;- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/sulfur.csv')

tuesdata &lt;- tidytuesdayR::tt_load('2020-05-12')
```

```

	Downloading file 1 of 5: `eruptions.csv`
	Downloading file 2 of 5: `events.csv`
	Downloading file 3 of 5: `sulfur.csv`
	Downloading file 4 of 5: `tree_rings.csv`
	Downloading file 5 of 5: `volcano.csv`
```

---
# dplyr()

- Pacote para a manipulação de dados
- Flexibilidade para transformar dados


```r
library(dplyr)
```

&lt;img src="https://didatica.tech/wp-content/uploads/2019/10/dplyr.png" width="40%" style="display: block; margin: auto;" /&gt;

---
# select()


```r
volcano %&gt;% 
  select(volcano_name, country, latitude:elevation) %&gt;% 
  head()
```

```
# A tibble: 6 x 5
  volcano_name    country       latitude longitude elevation
  &lt;chr&gt;           &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 Abu             Japan             34.5     132.        641
2 Acamarachi      Chile            -23.3     -67.6      6023
3 Acatenango      Guatemala         14.5     -90.9      3976
4 Acigol-Nevsehir Turkey            38.5      34.6      1683
5 Adams           United States     46.2    -121.       3742
6 Adatarayama     Japan             37.6     140.       1728
```

---
# select()


```r
volcano %&gt;% 
  select(-tectonic_settings) %&gt;% 
  head()
```

---
# funções que auxiliam na seleção das variáveis:

- **stars_with()**: colunas que começam com um prefixo
- **ends_with()**: colunas que terminam com um sufixo
- **contains()**: colunas que contêm uma string
- **last_col()**: última coluna


```r
volcano %&gt;% 
  select(starts_with("population"))
```

```
# A tibble: 958 x 4
   population_within_~ population_within_~ population_within~ population_within~
                 &lt;dbl&gt;               &lt;dbl&gt;              &lt;dbl&gt;              &lt;dbl&gt;
 1                3597                9594             117805            4071152
 2                   0                   7                294               9092
 3                4329               60730            1042836            7634778
 4              127863              127863             218469            2253483
 5                   0                  70               4019             393303
 6                 428                3936             717078            5024654
 7                 101                 485              18645            1242922
 8                  51                6042               8611             161009
 9                   0                   0                  0                  0
10                9890              114404            2530449            7441660
# ... with 948 more rows
```


---
# filter()


```r
volcano %&gt;% 
  select(volcano_name, country, latitude:elevation) %&gt;% 
  filter(country == "Antarctica")

volcano %&gt;% 
  select(volcano_name, country, latitude:elevation) %&gt;% 
  filter(!country == "Antarctica")

volcano %&gt;% 
  select(volcano_name, country, latitude:elevation) %&gt;% 
  filter(country == "Antarctica" | latitude &gt; 10)
```

---
# mutate()

- Modifica e cria colunas


```r
volcano %&gt;% 
  select(volcano_name, country, last_eruption_year) %&gt;% 
  filter(!country == "Antarctica") %&gt;% 
  mutate(last_eruption_year = as.numeric(last_eruption_year),
         years_ago = 2020 - last_eruption_year)
```

```
# A tibble: 941 x 4
   volcano_name    country       last_eruption_year years_ago
   &lt;chr&gt;           &lt;chr&gt;                      &lt;dbl&gt;     &lt;dbl&gt;
 1 Abu             Japan                      -6850      8870
 2 Acamarachi      Chile                         NA        NA
 3 Acatenango      Guatemala                   1972        48
 4 Acigol-Nevsehir Turkey                     -2080      4100
 5 Adams           United States                950      1070
 6 Adatarayama     Japan                       1996        24
 7 Adwa            Ethiopia                      NA        NA
 8 Afdera          Ethiopia                      NA        NA
 9 Agrigan         United States               1917       103
10 Agua            Guatemala                     NA        NA
# ... with 931 more rows
```

---
# if_else()

- retorna um valor dependendo de um teste lógico


```r
volcano %&gt;% 
  mutate(new_variable = if_else(last_eruption_year &lt;= 2000, "2000-", "2000+")) %&gt;% 
  count(new_variable)
```

```
# A tibble: 2 x 2
  new_variable     n
  &lt;chr&gt;        &lt;int&gt;
1 2000-          456
2 2000+          502
```

---
# case_when()

- generalização do if_else()


```r
volcano %&gt;% 
  mutate(new_variable = case_when(last_eruption_year &lt;= 2000 ~ "até 2000",
                                  last_eruption_year &lt;= 2010 ~ "até 2010",
                                  last_eruption_year &lt;= 2020 ~ "até 2020",
                                  TRUE ~ "outros")) %&gt;% 
  count(new_variable)
```

```
# A tibble: 4 x 2
  new_variable     n
  &lt;chr&gt;        &lt;int&gt;
1 até 2000       456
2 até 2010        42
3 até 2020       119
4 outros         341
```

- O TRUE significa que caso as observações não entrem nas condições anteriores a função retorna o valor do lado direito

---
# n() e n_distinct()

- n(): retorna o tamanho do grupo
- n_distinct(): retorna o número de tamanhos distintos


```r
volcano %&gt;% 
  select(volcano_name, country, latitude:elevation, last_eruption_year) %&gt;% 
  mutate(var = n(),
         var1 = n_distinct(last_eruption_year))
```

---
# group_by()

- sozinho não faz nenhuma alteração notável na base
- quando usado junto com funções como mutate() ou summarise() muda o escopo da função:
  - executa o código separadamente para cada grupo
  - trata de cada grupo como se fossem banco de dados distintos

# summarise()

- calcula medidas como:
  - média
  - desvio padrão
  - entre outras
  

```r
volcano %&gt;% 
  select(volcano_name, country, latitude:elevation, last_eruption_year) %&gt;% 
  filter(!country == "Antarctica") %&gt;% 
  group_by(country) %&gt;% 
  summarise(n = n(),
            media_lat = mean(elevation),
            sd_lat = sd(elevation),
            min = min(elevation, na.rm = TRUE),
            max = max(elevation, na.rm = TRUE)) %&gt;% 
  ungroup()
```

```
# A tibble: 88 x 6
   country                n media_lat sd_lat   min   max
   &lt;chr&gt;              &lt;int&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Algeria                1     1672     NA   1672  1672
 2 Argentina             14     3608.  1490.  1344  6095
 3 Armenia                3     3422.   775.  2575  4095
 4 Armenia-Azerbaijan     1     3029     NA   3029  3029
 5 Australia              2     1878   1226.  1011  2745
 6 Bolivia                3     4877   1064.  3650  5543
 7 Burma (Myanmar)        1     1518     NA   1518  1518
 8 Cameroon               3     2535.  1844.   500  4095
 9 Canada                18     1954.  1182. -2050  3160
10 Cape Verde             1     2829     NA   2829  2829
# ... with 78 more rows
```


---
# Perguntas: 

- Em qual país existem mais vulcões?


```r
volcano %&gt;% 
  group_by(country) %&gt;% 
  count(country, sort = TRUE)
```

- Nesse país, qual o tipo de vulcão mais comum?


```r
volcano %&gt;% 
  filter(country == "United States") %&gt;% 
  count(primary_volcano_type, sort = TRUE)
```

- Na América do Sul, quantos e quais vulcões entraram em erupção em 2020?


```r
volcano %&gt;% 
  select(region, volcano_name, last_eruption_year) %&gt;% 
  filter(region == "South America",
         last_eruption_year == "2020") %&gt;% 
  count(volcano_name, last_eruption_year)
```

- Quais os tipos de vulcões presentes em cada país?


```r
volcano %&gt;% 
  select(country, primary_volcano_type, major_rock_1) %&gt;% 
  mutate(primary_volcano_type = str_to_lower(primary_volcano_type),
         primary_volcano_type = str_replace(primary_volcano_type, " ", "_"),
         primary_volcano_type = str_replace(primary_volcano_type, "\\s*\\([^\\)]+\\)", ""),
         primary_volcano_type = str_replace(primary_volcano_type, "[:punct:]", "")) %&gt;% 
  count(country, primary_volcano_type, sort = TRUE) %&gt;% 
  pivot_wider(names_from = "primary_volcano_type",
              values_from = "n")
```

- Quais os países nos quais os vulcões apresentam maior risco para a população local (até 5 km)?


```r
volcano %&gt;% 
  select(country, population_within_5_km) %&gt;% 
  group_by(country) %&gt;% 
  summarise(n = n(),
            media_pop = mean(population_within_5_km),
            sd_pop = sd(population_within_5_km),
            max_pop = max(population_within_5_km)) %&gt;% 
  filter(n &gt; 2) %&gt;% #mais de 2 vulcões no país
  arrange(desc(media_pop))
```


---
# tidyr()


```r
library(tidyr)
```

&lt;img src="https://www.dadosaleatorios.com.br/post/introducao-ao-tidyr/featured.png" width="30%" style="display: block; margin: auto;" /&gt;

- O pacote possui funções para deixar os dados em formato *tidy*

- Dados **tidy** estão organizados de forma que:
  - cada linha é uma observação
  - cada coluna é uma variável 
  - cada célula representa um único valor

---
# pivot_longer()

- alonga os dados


```r
volcano_long = volcano %&gt;% 
  select(volcano_name, latitude, longitude) %&gt;% 
  pivot_longer(cols = c(latitude, longitude),
               names_to = "variable",
               values_to = "value")

volcano_long
```

```
# A tibble: 1,916 x 3
   volcano_name    variable   value
   &lt;chr&gt;           &lt;chr&gt;      &lt;dbl&gt;
 1 Abu             latitude    34.5
 2 Abu             longitude  132. 
 3 Acamarachi      latitude   -23.3
 4 Acamarachi      longitude  -67.6
 5 Acatenango      latitude    14.5
 6 Acatenango      longitude  -90.9
 7 Acigol-Nevsehir latitude    38.5
 8 Acigol-Nevsehir longitude   34.6
 9 Adams           latitude    46.2
10 Adams           longitude -121. 
# ... with 1,906 more rows
```


---
# pivot_wider()

- alarga os dados


```r
volcano %&gt;% 
  select(volcano_name, latitude, longitude, last_eruption_year) %&gt;% 
  mutate(last_eruption_year = case_when(last_eruption_year &lt;= 2000 ~ "before_2000",
                                        last_eruption_year &gt; 2000 ~ "after_2000")) %&gt;% 
  pivot_wider(names_from = last_eruption_year,
              values_from = latitude)
```

```
# A tibble: 958 x 4
   volcano_name    longitude before_2000 after_2000
   &lt;chr&gt;               &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;
 1 Abu                 132.         34.5       NA  
 2 Acamarachi          -67.6        NA        -23.3
 3 Acatenango          -90.9        14.5       NA  
 4 Acigol-Nevsehir      34.6        38.5       NA  
 5 Adams              -121.         NA         46.2
 6 Adatarayama         140.         37.6       NA  
 7 Adwa                 40.8        NA         10.1
 8 Afdera               40.9        NA         13.1
 9 Agrigan             146.         18.8       NA  
10 Agua                -90.7        NA         14.5
# ... with 948 more rows
```


---
# separate()

- separa uma coluna em várias usando um separador


```r
volcano %&gt;% 
  select(volcano_name, tectonic_settings) %&gt;% 
  separate(tectonic_settings,
           into = c("zone", "crust"),
           sep = " / ")
```

```
# A tibble: 958 x 3
   volcano_name    zone            crust                        
   &lt;chr&gt;           &lt;chr&gt;           &lt;chr&gt;                        
 1 Abu             Subduction zone Continental crust (&gt;25 km)   
 2 Acamarachi      Subduction zone Continental crust (&gt;25 km)   
 3 Acatenango      Subduction zone Continental crust (&gt;25 km)   
 4 Acigol-Nevsehir Intraplate      Continental crust (&gt;25 km)   
 5 Adams           Subduction zone Continental crust (&gt;25 km)   
 6 Adatarayama     Subduction zone Continental crust (&gt;25 km)   
 7 Adwa            Rift zone       Intermediate crust (15-25 km)
 8 Afdera          Rift zone       Intermediate crust (15-25 km)
 9 Agrigan         Subduction zone Crustal thickness unknown    
10 Agua            Subduction zone Continental crust (&gt;25 km)   
# ... with 948 more rows
```


---
# unite()

- junta várias colunas em uma usando um separador


```r
volcano %&gt;% 
  select(volcano_name, volcano_number) %&gt;% 
  unite(col = volcano_name, 
        volcano_number,
        volcano_name,
        sep = "_")
```

```
# A tibble: 958 x 1
   volcano_name          
   &lt;chr&gt;                 
 1 283001_Abu            
 2 355096_Acamarachi     
 3 342080_Acatenango     
 4 213004_Acigol-Nevsehir
 5 321040_Adams          
 6 283170_Adatarayama    
 7 221170_Adwa           
 8 221110_Afdera         
 9 284160_Agrigan        
10 342100_Agua           
# ... with 948 more rows
```


---
# nest()

- cria uma coluna de lista


```r
volcano_nest = volcano %&gt;% 
  group_by(country) %&gt;% 
  nest()
```


---
# unnest()

- desfaz a coluna de lista


```r
volcano_nest %&gt;% 
  unnest()
```

```
# A tibble: 958 x 26
# Groups:   country [89]
   country volcano_number volcano_name  primary_volcano~ last_eruption_y~ region
   &lt;chr&gt;            &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt; 
 1 Japan           283001 Abu           Shield(s)        -6850            Japan~
 2 Japan           283170 Adatarayama   Stratovolcano(e~ 1996             Japan~
 3 Japan           282080 Aira          Caldera          2020             Japan~
 4 Japan           283130 Akagisan      Stratovolcano    Unknown          Japan~
 5 Japan           285070 Akan          Caldera          2008             Japan~
 6 Japan           283230 Akita-Komaga~ Stratovolcano(e~ 1971             Japan~
 7 Japan           283260 Akita-Yakeya~ Stratovolcano    1997             Japan~
 8 Japan           282022 Akusekijima   Stratovolcano(e~ Unknown          Japan~
 9 Japan           284060 Aogashima     Stratovolcano    1785             Japan~
10 Japan           283110 Asamayama     Complex          2019             Japan~
# ... with 948 more rows, and 20 more variables: subregion &lt;chr&gt;,
#   latitude &lt;dbl&gt;, longitude &lt;dbl&gt;, elevation &lt;dbl&gt;, tectonic_settings &lt;chr&gt;,
#   evidence_category &lt;chr&gt;, major_rock_1 &lt;chr&gt;, major_rock_2 &lt;chr&gt;,
#   major_rock_3 &lt;chr&gt;, major_rock_4 &lt;chr&gt;, major_rock_5 &lt;chr&gt;,
#   minor_rock_1 &lt;chr&gt;, minor_rock_2 &lt;chr&gt;, minor_rock_3 &lt;chr&gt;,
#   minor_rock_4 &lt;chr&gt;, minor_rock_5 &lt;chr&gt;, population_within_5_km &lt;dbl&gt;,
#   population_within_10_km &lt;dbl&gt;, population_within_30_km &lt;dbl&gt;,
#   population_within_100_km &lt;dbl&gt;
```


    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
