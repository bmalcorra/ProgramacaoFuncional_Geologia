---
title: "Intensivão de programação funcional em R aplicado à Geologia"
subtitle: "⚒<br/>Aplicações e Exemplos"
author: "Bárbara Malcorra"
institute: "PUCRS"
date: '`r Sys.Date()`'
encoding: "UTF-8"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---

```{r xaringan-themer, include = FALSE, warning = FALSE}
library(xaringanthemer)

style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)
```


```{r, include = FALSE}
library(flipbookr)

knitr::opts_chunk$set(fig.width = 6,
                      message = FALSE,
                      warning = FALSE,
                      comment = "",
                      cache = FALSE)
```

---
# Estabelecendo um diretório de trabalho

```{r}
#setwd()
```

# Importando os dados

- de um arquivo .csv

```{r}
#dados = read.csv()
```

- de um arquivo excel

```{r}
# install.packages("readxl")
# library(readxl)
# 
# dados.ex = read_excel()
```

---
# Inspecionando os dados

```{r}
# View(dados) # não muito útil para data frames grandes
# names(dados)
# head(dados)
# str(dados)
# summary(dados)
```

---
# Tidyverse

```{r}
# install.packages("tidyverse")
library(tidyverse)
```


```{r, echo = FALSE, fig.align = 'center', out.width = "30%"}
knitr::include_graphics("https://www.business-science.io/assets/2020-10-15-must-know-tidyverse-features/tidyverse-icons.png")
```

---
# Pipe %>%

- Atalho Ctrl + Shift + M

- Analisa o código do lado esquerdo e passa o resultado como o primeiro argumento do código do lado direito

```{r, echo = FALSE, fig.align = 'center', out.width = "30%"}
knitr::include_graphics("https://magrittr.tidyverse.org/logo.png")
```

---
# Dados

- "Tidy Tuesday live screencast: Analyzing volcano eruptions in R" by David Robinson

<https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md>

```{r, message = FALSE, warning = FALSE}
volcano <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/volcano.csv')
eruptions <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/eruptions.csv')
events <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/events.csv')
tree_rings <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/tree_rings.csv')
sulfur <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/sulfur.csv')
```

---
# dplyr()

- Pacote para a manipulação de dados
- Flexibilidade para transformar dados

```{r}
# install.packages("dplyr")
library(dplyr)
```

```{r, echo = FALSE, fig.align = 'center', out.width = "40%"}
knitr::include_graphics("https://didatica.tech/wp-content/uploads/2019/10/dplyr.png")
```

---
# select()

```{r}
volcano %>% 
  select(volcano_name, country, latitude:elevation) %>% 
  head()
```

---
# select()

```{r, results = FALSE}
volcano %>% 
  select(-tectonic_settings) %>% 
  head()
```

---
# filter()

```{r, results = FALSE}
volcano %>% 
  select(volcano_name, country, latitude:elevation) %>% 
  filter(country == "Antarctica")

volcano %>% 
  select(volcano_name, country, latitude:elevation) %>% 
  filter(!country == "Antarctica")

volcano %>% 
  select(volcano_name, country, latitude:elevation) %>% 
  filter(country == "Antarctica" | latitude > 10)
```

---
# mutate()

- Modifica e cria colunas

```{r}
volcano %>% 
  select(volcano_name, country, latitude:elevation, last_eruption_year) %>% 
  filter(!country == "Antarctica") %>% 
  mutate(last_eruption_year = as.numeric(last_eruption_year),
         years_ago = 2020 - last_eruption_year)
```

---
# if_else()

- retorna um valor dependendo de um teste lógico

```{r}
volcano %>% 
  mutate(new_variable = if_else(last_eruption_year <= 2000, "2000-", "2000+")) %>% 
  count(new_variable)
```

---
# case_when()

- generalização do if_else()

```{r}
volcano %>% 
  mutate(new_variable = case_when(last_eruption_year <= 2000 ~ "até 2000",
                                  last_eruption_year <= 2010 ~ "até 2010",
                                  last_eruption_year <= 2020 ~ "até 2020",
                                  TRUE ~ "outros")) %>% 
  count(new_variable)
```

- O TRUE significa que caso as observações não entrem nas condições anteriores a função retorna o valor do lado direito

---
# n() e n_distinct()

- n(): retorna o tamanho do grupo
- n_distinct(): retorna o número de tamanhos distintos

```{r, results = FALSE}
volcano %>% 
  select(volcano_name, country, latitude:elevation, last_eruption_year) %>% 
  mutate(var = n(),
         var1 = n_distinct(last_eruption_year))
```

---
# group_by()

- sozinho não faz nenhuma alteração notável na base
- quando usado junto com funções como mutate() ou summarise() muda o escopo da função:
  - executa o código separadamente para cada grupo
  - trata de cada grupo como se fossem banco de dados distintos

# summarise()

- calcula medidas como:
  - média
  - desvio padrão
  - entre outras
  
```{r}
volcano %>% 
  select(volcano_name, country, latitude:elevation, last_eruption_year) %>% 
  filter(!country == "Antarctica") %>% 
  group_by(country) %>% 
  summarise(n = n(),
            media_lat = mean(elevation),
            sd_lat = sd(elevation)) %>% 
  ungroup()
```


---
# Perguntas: 

- Em qual região existem mais vulcões?

```{r}
volcano %>% 
  count(region, sort = TRUE)
```

- 

```{r}
volcano %>% 
  mutate(last_eruption_year = as.numeric(last_eruption_year)) %>% 
  ggplot(aes(last_eruption_year, fill = evidence_category)) +
  geom_histogram()
```



---
# tidyr()

```{r}
# install.packages("tidyr")
library(tidyr)
```

```{r, echo = FALSE, fig.align = 'center', out.width = "30%"}
knitr::include_graphics("https://www.dadosaleatorios.com.br/post/introducao-ao-tidyr/featured.png")
```

- O pacote possui funções para deixar os dados em formato *tidy*

- Dados **tidy** estão organizados de forma que:
  - cada linha é uma observação
  - cada coluna é uma variável 
  - cada célula representa um único valor

---
# pivot_longer()

- alonga os dados

```{r}
volcano_long = volcano %>% 
  select(volcano_name, latitude, longitude) %>% 
  pivot_longer(cols = c(latitude, longitude),
               names_to = "variable",
               values_to = "value")

volcano_long
```


---
# pivot_wider()

- alarga os dados

```{r}
volcano %>% 
  select(volcano_name, latitude, longitude, last_eruption_year) %>% 
  mutate(last_eruption_year = case_when(last_eruption_year <= 2000 ~ "before_2000",
                                        last_eruption_year > 2000 ~ "after_2000")) %>% 
  pivot_wider(names_from = last_eruption_year,
              values_from = latitude)
```


---
# separate()

- separa uma coluna em várias usando um separador

```{r}
volcano %>% 
  select(volcano_name, tectonic_settings) %>% 
  separate(tectonic_settings,
           into = c("zone", "crust"),
           sep = " / ")
```


---
# unite()

- junta várias colunas em uma usando um separador

```{r}
volcano %>% 
  select(volcano_name, volcano_number) %>% 
  unite(col = volcano_name, 
        volcano_number,
        volcano_name,
        sep = "_")
```


---
# nest()

- cria uma coluna de lista

```{r}
volcano_nest = volcano %>% 
  group_by(country) %>% 
  nest()
```


---
# unnest()

- desfaz a coluna de lista

```{r}
volcano_nest %>% 
  unnest()
```


---
# ggplot

`r chunk_reveal("teste")`

```{r teste, warning=FALSE, message=FALSE}
volcano %>% 
  filter(country == "Antarctica") %>% 
  ggplot(aes(elevation, longitude, color = primary_volcano_type)) +
  geom_point()
```


