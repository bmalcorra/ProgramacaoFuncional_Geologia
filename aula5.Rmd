---
title: "Aula 5 - Dados espaciais"
author: "Gabriel Bertolini"
date: "18/07/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Dados espaciais

- Dados espaciais apresentam peculiaridades em relação aos objetos que havíamos trabalhado anteriormente
- Para trabalhar com dados espaciais, devemos utilizar pacote sf (ou outros como STARS, RASTER, TERRA)

- Quais são as informações necessárias para configurar um dado espacial
 - Coordenadas (geográficas ou projetada)
 - Coordinate Reference System (CRS) 
 - Vamos usar como exemplo o banco de dados "volcano"

```{r}
volcano<-read.csv("volcano.csv")
View(volcano)
```
---

- BD apresenta colunas latitude e longitute em coordenadas geográficas em graus decimais 
- Primeiro vamos importar pacote sf que vai transformar esse banco de dados em objeto espacial
- Função "st_as_sf" transforma banco de dados em dados espaciais
  - definir qual coluna é o x e y / long e lat no parâmetro coords

```{r}
library(sf)
library(tidyverse)
volcano %>% st_as_sf(coords=c("longitude","latitude"))
# como setar sistema de coordenada?

```
---

- Sistema de referência do banco de dados é WGS-84 lat/long
- Vamos pesquisar qual o codigo desse sistema no site "https://epsg.io/"
- Podemos trocar o sistema por algum sistema de coordenadas projetada, usando a função st_transform()

```{r}
volcano %>% st_as_sf(coords=c("longitude","latitude"), crs=4326) # WGS 84

volcano %>% st_as_sf(coords=c("longitude","latitude"), crs=4326) %>% 
  st_transform(crs = 3857) # WGS84 projetada (pseudo-mercator)

```
---

- pacote SF apresenta uma série de funções para lidar com GIS, por exemplo
  - st_
  
---
- Vamos plotar esses dados e ver como ficar..
- para isso, vamos utilizar o pacote de mapas interativos mapview()



```{r}
library(mapview)
volcano %>% st_as_sf(coords=c("longitude","latitude"), crs=4326) %>% 
mapview()
```
---
- parâmetro zcol ="nome_da_coluna" adiciona cor ao pontos
```{r}
library(mapview)
volcano %>% st_as_sf(coords=c("longitude","latitude"), crs=4326) %>% 
mapview(zcol="elevation")
```

--- 
# Exercício 1
- Mapear vulcões com maio georisco associados a populações de 5, 10 e 30 km

# 5km
```{r}

volcano %>% mutate(pop_5km=as.double(population_within_5_km),
                   pop_5km=if_else(pop_5km==0,0,log10(pop_5km))) %>% 
  st_as_sf(coords=c("longitude","latitude"), crs=4326) %>% 
  mapview(zcol="pop_5km")
```

# 10km
```{r}
volcano %>% mutate(pop_10km=as.double(population_within_10_km),
                   pop_10km=if_else(pop_10km==0,0,log10(pop_10km))) %>% 
  st_as_sf(coords=c("longitude","latitude"), crs=4326) %>% 
mapview(zcol="pop_10km")
```

# 30km
```{r}
volcano %>% mutate(pop_30km=as.double(population_within_30_km),
                   pop_30km=if_else(pop_30km==0,0,log10(pop_30km))) %>% 
  st_as_sf(coords=c("longitude","latitude"), crs=4326) %>% 
mapview(zcol="pop_30km")
```


# Exercício 2
- Mapear tipos de vulcões

# 5km
```{r}
library(stringr)
volcano %>%  mutate(primary_volcano_type = str_to_lower(primary_volcano_type),
         primary_volcano_type = str_replace(primary_volcano_type, " ", "_"),
         primary_volcano_type = str_replace(primary_volcano_type, "\\s*\\([^\\)]+\\)", ""),
         primary_volcano_type = str_replace(primary_volcano_type, "[:punct:]", "")) %>% 
  st_as_sf(coords=c("longitude","latitude"), crs=4326) %>% 
  mapview(zcol="primary_volcano_type")
```


---

# Pacote TMAP
- pacote tmap tem estrutura similar ao GGPLOT
- pacote voltado a mapas temáticos

```{r}
library(tmap)
library(tidyverse)
library(tmaptools)

tmaptools::palette_explorer() 

data(World)
World 

volca<-volcano %>% pivot_longer(population_within_5_km:population_within_30_km, values_to="value", names_to="var") %>% 
  mutate(value=as.numeric(value),
         primary_volcano_type = str_to_lower(primary_volcano_type),
         primary_volcano_type = str_replace(primary_volcano_type, " ", "_"),
         primary_volcano_type = str_replace(primary_volcano_type, "\\s*\\([^\\)]+\\)", ""),
         primary_volcano_type = str_replace(primary_volcano_type, "[:punct:]", "")) %>% 
   st_as_sf(coords=c("longitude","latitude"), crs=4326)

 tm_shape(World) +
  tm_polygons()+
  tm_shape(volca)+
  tm_dots(col="primary_volcano_type",size=.35,palette = "Set1", n = 17)+
  tm_compass(type="4star")+
  tm_grid(alpha = 0.5)+
  tm_layout(main.title="Types of volcanos",
  legend.outside="T")+
  tm_scale_bar(position=c("left", "bottom"))+
  tmap_style("classic")
```



```{r}

  tm_shape(World) +
  tm_polygons("continent")+
  tm_shape(volca)+
  tm_dots(col="value",size=.2,style="kmeans",palette = "viridis", n = 5, contrast = c(0.29, 1))+
  tm_compass(type="4star")+
  tm_grid(alpha = 0.5)+
  tm_layout(main.title="Evaluation of volcano-eruption geohazard",
  legend.outside="T")+
  tm_scale_bar(position=c("left", "bottom"))+
  tm_facets(by="var")
  

```


